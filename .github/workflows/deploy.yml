# Názov workflow, ktorý sa zobrazí v záložke Actions
name: Gradle CI/CD & Deploy (Debian VPS)

# Spustenie pri push do main vetvy, pri Pull Request alebo manuálne
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Umožní deploy jobu získať názov JAR súboru
    outputs:
      jar_name: ${{ steps.get_jar_name.outputs.JAR_NAME }} # Použije sa v kroku deploy

    # KROK 1: BUILD a TEST
    steps:
      - uses: actions/checkout@v4

      # KROK NA LADENIE - overí načítanie všetkých dôležitých premenných a Secretov
      - name: Debug Environment and Secrets Load
        run: |
          echo "--- START DEBUG ---"
          echo "APP_DIR (env): ${{ env.APP_DIR }}"
          echo "VPS_HOST (secret): ${{ secrets.VPS_HOST }}"
          echo "VPS_USER (secret): ${{ secrets.VPS_USER }}"
          echo "VPS_PORT (secret): ${{ secrets.VPS_PORT }}"
          echo "JAR_NAME (output): ${{ needs.build.outputs.jar_name }}"
          
          # TENTO RIADOK MUSÍ VRÁTIŤ ***. Ak vráti prázdny reťazec alebo chybu, secret sa nenačítal.
          echo "SSH_PRIVATE_KEY (LOAD STATUS): ${{ secrets.SSH_PRIVATE_KEY }}"
          echo "--- END DEBUG ---"


      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          # Zmena cache z maven na gradle
          cache: gradle

      # Zmena z Maven príkazu na Gradle Wrapper príkaz
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        # Používa sa typický Gradle príkaz na clean a build
        run: ./gradlew clean build

      # Nájde názov vygenerovaného JAR súboru (štandardne sa ukladá do build/libs)
      - name: Get JAR file name
        id: get_jar_name
        # Štandardná cesta pre Spring Boot JAR je build/libs/
        # Hľadáme v build/libs/ (zvyčajne je tam len jeden)
        run: echo "JAR_NAME=$(find build/libs/ -name "*.jar" | head -n 1 | xargs basename)" >> $GITHUB_OUTPUT

  deploy:
    needs: build # Spustí sa len, ak bol build úspešný
    # Pridávame 'if' podmienku, aby sa deploy nespustil na Pull Requestoch (dobrá prax)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    environment: Production
    env:
      APP_DIR: /opt/nexus-chunk # Cieľový adresár na VPS

    steps:
      # 1. Skopíruje nový JAR pomocou SCP
      - name: Copy JAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Zmena cesty zo 'target/' na 'build/libs/'
          source: "build/libs/${{ needs.build.outputs.jar_name }}"
          target: ${{ env.APP_DIR }}
          # strip_components: 2 # Pre Gradle je lepšie použiť 2, ak sa kopíruje z build/libs/

      # 2. Spustí aplikáciu (cez SSH)
      - name: Stop, Rename, and Start Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Stopping existing service..."
            sudo systemctl stop nexus-chunk || true
            
            # Premenuje skopírovaný JAR (ktorý bol skopírovaný s originálnym názvom)
            cd ${{ env.APP_DIR }}
            NEW_JAR_NAME="${{ needs.build.outputs.jar_name }}"
            # Premenuje nový súbor na app.jar (toto je dôležité pre systemd!)
            mv "$NEW_JAR_NAME" app.jar
            
            # Spustí novú inštanciu
            echo "Starting new service instance..."
            sudo systemctl start nexus-chunk
            
            echo "Deployment successful."