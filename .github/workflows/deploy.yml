# Názov workflow, ktorý sa zobrazí v záložke Actions
name: Gradle CI/CD & Deploy (Debian VPS)

# Spustenie pri push do main vetvy, pri Pull Request alebo manuálne
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Umožní deploy jobu získať názov JAR súboru
    outputs:
      jar_name: ${{ steps.get_jar_name.outputs.JAR_NAME }} # Použije sa v kroku deploy

    # KROK 1: BUILD a TEST
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build

      # Nájde názov vygenerovaného JAR súboru (štandardne sa ukladá do build/libs)
      - name: Get JAR file name
        id: get_jar_name
        # Štandardná cesta pre Spring Boot JAR je build/libs/
        run: echo "JAR_NAME=$(find build/libs/ -name "*.jar" | head -n 1 | xargs basename)" >> $GITHUB_OUTPUT

      # ULOŽENIE SÚBORU PRE DEPLOY JOB
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexus-chunk-jar # Názov artefaktu, ktorý použijeme na stiahnutie
          path: build/libs/*.jar # Cesta k vygenerovanému JAR súboru
          retention-days: 1

  deploy:
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    environment: Deploy

    # *** KRITICKÁ ZMENA: Cieľový adresár je v Home adresári, kde má používateľ práva. ***
    env:
      APP_DIR: /home/invouk/nexus-chunk

    steps:
      # 1. STIAHNUTIE ARTEFAKTU DO KOREŇA
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: nexus-chunk-jar
          path: .

      # 2. Skopíruje nový JAR pomocou SCP (Tento krok už nevyžaduje sudo)
      - name: Copy JAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "${{ needs.build.outputs.jar_name }}"
          target: ${{ env.APP_DIR }}

      # 3. Spustí aplikáciu (cez SSH)
      - name: Stop, Rename, and Start Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Stopping existing service..."
            # Zastavenie Služby (vyžaduje sudo)
            sudo systemctl stop nexus-chunk || true
            
            # Premenovanie súboru (v adresári invouk, bez sudo)
            cd ${{ env.APP_DIR }}
            NEW_JAR_NAME="${{ needs.build.outputs.jar_name }}"
            mv "$NEW_JAR_NAME" app.jar
            
            # Spustí novú inštanciu
            echo "Starting new service instance..."
            # Spustenie Služby (vyžaduje sudo)
            sudo systemctl start nexus-chunk
            
            echo "Deployment successful."