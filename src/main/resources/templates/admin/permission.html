<!DOCTYPE html>
<html lang="sk" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/head :: head('NexusChunk Server | Správa Rolí', false)}"></div>

    <link rel="stylesheet" th:href="@{/css/admin.style.css}">
</head>
<body>

<div class="admin-wrapper">
    <div th:replace="~{/admin/fragments/admin_navbar :: admin_navbar('permissions')}"></div>

    <div class="admin-main-content">
        <h1 class="section-title"><i class="fa-solid fa-users-gear"></i> Správa Oprávnení a Rolí</h1>

        <div th:if="${successMessage}" class="alert alert-success mt-3" role="alert" th:text="${successMessage}">
            Rola bola úspešne uložená!
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger mt-3" role="alert" th:text="${errorMessage}">
            Nastala chyba pri spracovaní roly.
        </div>

        <div class="roles-grid">

            <div class="role-list">

                <div class="admin-card" style="margin-bottom: 25px;">
                    <h4><i class="fa-solid fa-list-check"></i> Zoznam Existujúcich Rolí</h4>

                    <ul th:if="${!#lists.isEmpty(roles)}">
                        <li th:each="role : ${roles}"
                            th:classappend="${selectedRole != null and role.id == selectedRole.id} ? 'selected' : ''">

                            <a th:href="@{/admin/permissions(roleId=${role.id})}"
                               title="Upraviť rolu"
                               style="display: flex; justify-content: space-between; align-items: center; width: 100%;">

                                <span th:text="${role.name}">ADMIN</span>

                                <i class="fa-solid fa-arrow-right-to-bracket" style="color: var(--accent-color);"></i>
                            </a>

                        </li>
                    </ul>
                    <div th:if="${#lists.isEmpty(roles)}" class="alert alert-info">Žiadne roly neboli nájdené.</div>
                </div>


                <div class="admin-card">
                    <h4><i class="fa-solid fa-plus"></i> Vytvoriť Novú Rolu</h4>
                    <form th:action="@{/admin/permissions/create}" method="post" th:object="${newRole}">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="newRoleName" class="stat-label">Názov Roly (napr. TESTER):</label>
                            <input type="text" id="newRoleName" name="newRoleName" th:field="*{newRoleName}" placeholder="Názov roly (veľké písmená)" required class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="newRoleDisplay" class="stat-label">Zobrazovaný názov (Nepoužité v entite Role):</label>
                            <input type="text" id="newRoleDisplay" name="newRoleDisplay" th:field="*{newRoleDisplay}" placeholder="Zobrazovaný názov" required class="form-control">
                        </div>
                        <button type="submit" class="btn-admin" style="background-color: var(--accent-color-success);"><i class="fa-solid fa-plus"></i> Vytvoriť</button>
                    </form>
                </div>

            </div>

            <div class="role-details" th:if="${selectedRole != null}">

                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px;">
                        <h4 style="border: none; margin: 0; padding: 0; color: var(--accent-color);">
                            Úprava Oprávnení pre: <span th:text="${selectedRole.name}">ADMIN</span>
                        </h4>
                    </div>

                    <form th:action="@{/admin/permissions/update}" method="post">
                        <input type="hidden" name="roleId" th:value="${selectedRole.id}" />

                        <div class="column-headers-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--border-color);">
                            <h5 style="color: var(--text-light); margin-bottom: 0;"><i class="fa-solid fa-eye"></i> Zobrazenie</h5>
                            <h5 style="color: var(--text-light); margin-bottom: 0;"><i class="fa-solid fa-pencil"></i> Zápis alebo úprava</h5>
                            <h5 style="color: var(--text-light); margin-bottom: 0;"><i class="fa-solid fa-gear"></i> Iné</h5>
                        </div>

                        <div th:each="entry : ${groupedPermissions}">

                            <h4 style="margin-top: 25px; color: var(--accent-color); padding-bottom: 5px; border-bottom: 1px solid var(--border-color);">
                                <i class="fa-solid fa-folder-open"></i>  <span th:text="${entry.key}">MEMBERS</span>
                            </h4>

                            <div class="permission-section-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">

                                <div class="column-view">
                                    <div th:each="permission : ${entry.value}">
                                        <th:block th:if="${#strings.startsWith(permission.name, 'VIEW_')}">

                                            <div class="stat-group" style="border-bottom: 1px dotted var(--border-color); padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                                                <div style="display: flex; align-items: center;">

                                                    <input type="checkbox" th:id="${'perm-' + permission.id}" name="permissionCodes" th:value="${permission.name}"
                                                           th:checked="${assignedPermissions.contains(permission.name)}" style="transform: scale(1.1); margin-right: 15px"
                                                    />

                                                    <label th:for="${'perm-' + permission.id}" class="stat-label" style="font-weight: bold; margin-bottom: 0;">
                                                        <span>Povoliť zobrazenie</span>
                                                        <span th:text="${@permissions.PERMISSION_DESCRIPTIONS.get(permission.name)}">Popis oprávnenia</span>
                                                        <small style="color: var(--text-secondary); display: block; font-weight: normal;">(<th:block th:text="${permission.name}"></th:block>)</small>
                                                    </label>
                                                </div>
                                                <span class="permission-badge"
                                                      th:classappend="${assignedPermissions.contains(permission.name)} ? 'bg-success' : 'bg-danger'"
                                                      style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; min-width: 80px; text-align: center;"
                                                      th:text="${assignedPermissions.contains(permission.name)} ? 'AKTÍVNE' : 'NEAKTÍVNE'">AKTÍVNE</span>
                                            </div>

                                        </th:block>
                                    </div>
                                </div>

                                <div class="column-write">
                                    <div th:each="permission : ${entry.value}">
                                        <th:block th:if="${(#strings.startsWith(permission.name, 'CREATE_') or #strings.startsWith(permission.name, 'EDIT_') or #strings.startsWith(permission.name, 'UPDATE_') or #strings.startsWith(permission.name, 'DELETE_'))}">

                                            <div class="stat-group" style="border-bottom: 1px dotted var(--border-color); padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                                                <div style="display: flex; align-items: center;">

                                                    <input type="checkbox" th:id="${'perm-' + permission.id}" name="permissionCodes" th:value="${permission.name}"
                                                           th:checked="${assignedPermissions.contains(permission.name)}" style="transform: scale(1.1); margin-right: 15px"
                                                    />

                                                    <label th:for="${'perm-' + permission.id}" class="stat-label" style="font-weight: bold; margin-bottom: 0;">
                                                        <span th:text="${@permissions.PERMISSION_DESCRIPTIONS.get(permission.name)}">Popis oprávnenia</span>

                                                        <small style="color: var(--text-secondary); display: block; font-weight: normal;">(<th:block th:text="${permission.name}"></th:block>)</small>
                                                    </label>
                                                </div>
                                                <span class="permission-badge"
                                                      th:classappend="${assignedPermissions.contains(permission.name)} ? 'bg-success' : 'bg-danger'"
                                                      style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; min-width: 80px; text-align: center;"
                                                      th:text="${assignedPermissions.contains(permission.name)} ? 'AKTÍVNE' : 'NEAKTÍVNE'">AKTÍVNE</span>
                                            </div>

                                        </th:block>
                                    </div>
                                </div>

                                <div class="column-other">
                                    <div th:each="permission : ${entry.value}">

                                        <th:block th:if="${
                        (
                            !#strings.startsWith(permission.name, 'VIEW_') and
                            !#strings.startsWith(permission.name, 'CREATE_') and
                            !#strings.startsWith(permission.name, 'EDIT_') and
                            !#strings.startsWith(permission.name, 'UPDATE_') and
                            !#strings.startsWith(permission.name, 'DELETE_')
                        )

                    }">

                                            <div class="stat-group" style="border-bottom: 1px dotted var(--border-color); padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                                                <div style="display: flex; align-items: center;">

                                                    <input type="checkbox" th:id="${'perm-' + permission.id}" name="permissionCodes" th:value="${permission.name}"
                                                           th:checked="${assignedPermissions.contains(permission.name)}" style="transform: scale(1.1); margin-right: 15px"
                                                    />

                                                    <label th:for="${'perm-' + permission.id}" class="stat-label" style="font-weight: bold; margin-bottom: 0;">
                                                        <span th:text="${@permissions.PERMISSION_DESCRIPTIONS.get(permission.name)}">Popis oprávnenia</span>



                                                        <small style="color: var(--text-secondary); display: block; font-weight: normal;">(<th:block th:text="${permission.name}"></th:block>)</small>
                                                    </label>
                                                </div>

                                                <span class="permission-badge" th:classappend="${assignedPermissions.contains(permission.name)} ? 'bg-success' : 'bg-danger'"
                                                      style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; min-width: 100px; text-align: center;">
                                <th:block th:if="${assignedPermissions.contains(permission.name)}"><i class="fa-solid fa-check"></i> AKTÍVNE</th:block>
                                <th:block th:unless="${assignedPermissions.contains(permission.name)}"><i class="fa-solid fa-xmark"></i> NEAKTÍVNE</th:block>
                            </span>
                                            </div>

                                        </th:block>
                                    </div>
                                </div>

                            </div> </div>
                        <div class="d-flex justify-content-end gap-3" style="margin-top: 30px;">
                            <button type="submit" class="btn-admin" style="background-color: var(--accent-color-success);">
                                <i class="fa-solid fa-save"></i> Uložiť Zmeny
                            </button>

                        <form th:action="@{/admin/permissions/delete/{roleId}(roleId=${selectedRole.id})}" method="post"
                              th:if="${selectedRole.name != 'USER'}"
                              onsubmit="return confirm('Ste si istý, že chcete ZMAZAŤ rolu: ' + this.getAttribute('data-role-name') + '? Táto akcia je nevratná!');"
                              th:data-role-name="${selectedRole.name}"
                              >
                            <button type="submit" class="btn-admin" style="background-color: var(--offline-color);">
                                <i class="fa-solid fa-trash"></i> Zmazať Rolu
                            </button>
                        </form>



                        </div>
                    </form>

                </div>
            </div>

            <div class="role-details" th:if="${selectedRole == null}">
                <div class="admin-card alert alert-info text-center">
                    Vyberte rolu zo zoznamu vľavo pre úpravu oprávnení.
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>